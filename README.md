# 概述
阿里云的RDS有每天20W条数据导出的限制，为了摆脱这个限制，我们使用 php 自己写了一个命令行工具

# 原理

从生产机RDS中查询所有数据，写入静态文件，读取静态文件，再插入目标数据库；
为了减少内存压力，使用分段导出，分段存储，分段规则为每批次 10000 条；

- 存储静态文件的过程：

	0. fopen 产生一个文件描述符；
	1. 每次查询10000条数据之后（此时数据在内存中）；
	2. 将内存中的数据**逐行**fwrite到文件描述符（fopen）；
	3. 循环写入完毕之后，fclose 文件描述符。
	
- 读取静态文件到目标表的过程：

	0. fopen目标文件
	1. fread逐行读取
	2. 读够10000行（此时数据在内存中），批量插入数据库表（目标）
	3. 循环读取直到EOF


# 代码位置及使用方法

位于测试服务器 `/root/bak_database` 目录下：
1. 其中 `out.php` 是从生产机导出数据，使用方法为 `php out.php 要导出的表名`；
2. 其中 `in.php` 是把从第 1 步导出的文件导入到目标数据库中，使用方法为 `php in.php 指定文件 目标表名`。

# 使用注意

实际使用的时候，观察发现，超过约 70W 条数据的时候，导出速度就会变慢，所以大量数据最好是找到大片连续时间来导出
